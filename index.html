<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Receipt Verify — Demo</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
<main class="wrap">
  <header class="hero">
    <h1>Receipt Verify — Demo</h1>
    <p class="muted">
      Tap <b>Verify</b> to check a signed receipt (Ed25519). We remove <code>sig</code>, canonicalize the JSON,
      and verify the signature against the public key. Works offline.
    </p>
    <ol class="steps">
      <li>Tap <b>Verify</b> on Green and Amber — they should show <span class="ok">VALID</span>.</li>
      <li>Use <b>Copy</b> or <b>Download</b> to take the receipt elsewhere.</li>
      <li>Paste any receipt in the box at the bottom and verify it too.</li>
    </ol>
  </header>

  <section class="card">
    <label class="label">Public key (hex)</label>
    <div class="row gap">
      <input id="pubHex" class="input mono" readonly value="(generating…)"/>
      <button class="btn ghost" onclick="copyText('pubHex')">Copy key</button>
    </div>
    <p class="fine">For production, fetch from <code>/.well-known/receipts.json</code> and cache for airplane-mode verify.</p>
  </section>

  <!-- RECEIPT CARDS -->
  <section class="grid">
    <!-- GREEN -->
    <article class="card">
      <h3>Green <span class="pill green">write</span></h3>

      <!-- Human summary -->
      <div class="receiptView" id="greenView"></div>

      <!-- Buttons: big, spaced, fat-finger friendly -->
      <div class="btnrow">
        <button class="btn primary" onclick="verifyFromScript('greenJson','greenResult')">Verify</button>
        <button class="btn" onclick="copyScript('greenJson')">Copy</button>
        <button class="btn" onclick="downloadScript('greenJson','green-receipt.json')">Download</button>
      </div>

      <!-- Result -->
      <div id="greenResult" class="result"></div>

      <!-- Raw JSON (hidden by default) -->
      <details class="raw">
        <summary>Show JSON</summary>
        <pre class="pre"><code class="mono" id="greenPretty"></code></pre>
      </details>
      <script id="greenJson" type="application/json">{}</script>
    </article>

    <!-- AMBER -->
    <article class="card">
      <h3>Amber <span class="pill amber">revoke</span></h3>

      <div class="receiptView" id="amberView"></div>

      <div class="btnrow">
        <button class="btn primary" onclick="verifyFromScript('amberJson','amberResult')">Verify</button>
        <button class="btn" onclick="copyScript('amberJson')">Copy</button>
        <button class="btn" onclick="downloadScript('amberJson','amber-receipt.json')">Download</button>
      </div>

      <div id="amberResult" class="result"></div>

      <details class="raw">
        <summary>Show JSON</summary>
        <pre class="pre"><code class="mono" id="amberPretty"></code></pre>
      </details>
      <script id="amberJson" type="application/json">{}</script>
    </article>
  </section>

  <!-- PASTE-ANY RECEIPT -->
  <section class="card">
    <h3>Paste any receipt</h3>
    <textarea id="pasteArea" class="input mono" rows="8" placeholder='Paste JSON here…'></textarea>
    <div class="btnrow">
      <button class="btn primary" onclick="verifyText('pasteArea','pasteResult')">Verify</button>
      <button class="btn" onclick="downloadText('pasteArea','pasted-receipt.json')">Download</button>
      <button class="btn" onclick="copyText('pasteArea')">Copy</button>
    </div>
    <div id="pasteResult" class="result"></div>
  </section>

  <section class="card">
    <h3>How it works</h3>
    <ol class="steps">
      <li>Stable-sort JSON keys deeply (JCS-style), remove <code>sig</code>.</li>
      <li>Encode to bytes with <code>TextEncoder</code>.</li>
      <li>Verify detached signature using Ed25519 and the public key.</li>
    </ol>
    <p class="fine">Fields shown: <code>rid</code>, <code>when</code>, <code>where</code>, <code>what.badge</code>, <code>flags</code>, <code>kid</code>, optional <code>revoke_of</code>.</p>
  </section>

  <footer class="foot">
    <div>We never collect prompts, chats, photos, or PII in this demo.</div>
    <div class="muted">© 2025</div>
  </footer>
</main>

<!-- tweetnacl (for Ed25519) -->
<script src="https://cdn.jsdelivr.net/npm/tweetnacl@1.0.3/nacl.min.js"></script>
<script>
  // ---------- helpers ----------
  const $ = id => document.getElementById(id);
  const hexToU8 = h => new Uint8Array((h.match(/.{1,2}/g)||[]).map(b=>parseInt(b,16)));
  const u8ToHex = u8 => [...u8].map(b=>b.toString(16).padStart(2,'0')).join('');
  const canon = v => Array.isArray(v)
      ? `[${v.map(canon).join(',')}]`
      : (v && typeof v==='object')
        ? `{${Object.keys(v).sort().map(k=>`${JSON.stringify(k)}:${canon(v[k])}`).join(',')}}`
        : JSON.stringify(v);

  function copyText(id){ const el=$(id); navigator.clipboard.writeText(el.value ?? el.innerText); }
  function copyScript(id){ navigator.clipboard.writeText($(id).textContent.trim()); }
  function download(filename, text){
    const blob = new Blob([text], {type:'application/json'});
    const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
  }
  function downloadScript(id, name){ download(name, $(id).textContent.trim()); }
  function downloadText(id, name){ download(name, $(id).value.trim()); }

  function verifyFromScript(scriptId, resultId){
    verifyJson($(scriptId).textContent.trim(), resultId);
  }
  function verifyText(textId, resultId){
    verifyJson($(textId).value.trim(), resultId);
  }
  function verifyJson(txt, resultId){
    try{
      const obj = JSON.parse(txt);
      const sigHex = obj.sig || '';
      delete obj.sig;
      const msg = new TextEncoder().encode(canon(obj));
      const sig = hexToU8(sigHex);
      const pub = hexToU8($('pubHex').value.replace(/[^0-9a-f]/gi,''));
      const ok = nacl.sign.detached.verify(msg, sig, pub);
      $(resultId).innerHTML = ok ? '<span class="ok">VALID</span>' : '<span class="bad">INVALID</span>';
    }catch(e){
      $(resultId).innerHTML = '<span class="bad">PARSE ERROR</span>';
    }
  }

  // ---------- demo receipts with real signatures ----------
  (function init(){
    // Generate a fresh demo keypair so the example receipts actually verify
    const kp = nacl.sign.keyPair();
    const pubHex = u8ToHex(kp.publicKey);
    $('pubHex').value = pubHex;

    const now = Math.floor(Date.now()/1000);

    const green = {
      rid: crypto.randomUUID(),
      when: now,
      where: {host:"demo", coarse:"device:server"},
      what: {badge:"green", kind:"memory"},
      flags: ["mem.write"],
      kid: "dev-1"
    };
    const amber = {
      rid: crypto.randomUUID(),
      when: now+60,
      where: {host:"demo", coarse:"device:server"},
      what: {badge:"amber", kind:"memory"},
      flags: ["mem.revoke"],
      revoke_of: green.rid,
      kid: "dev-1"
    };

    // Sign (detached) the canonicalized JSON-without-sig
    function signReceipt(r){
      const m = new TextEncoder().encode(canon(r));
      const sig = nacl.sign.detached(m, kp.secretKey);
      return {...r, sig: u8ToHex(sig)};
    }

    const greenSigned = signReceipt(green);
    const amberSigned = signReceipt(amber);

    // Store exact JSON in <script type="application/json"> for machine use
    $('greenJson').textContent = JSON.stringify(greenSigned);
    $('amberJson').textContent = JSON.stringify(amberSigned);

    // Pretty JSON (for Show JSON)
    $('greenPretty').innerText = JSON.stringify(greenSigned, null, 2);
    $('amberPretty').innerText = JSON.stringify(amberSigned, null, 2);

    // Human receipt view cards
    function mkView(r, elId){
      const dt = new Date(r.when*1000).toLocaleString();
      $(elId).innerHTML = `
        <div class="kv"><span>RID</span><code class="mono cut">${r.rid}</code></div>
        <div class="kv"><span>When</span><span>${dt}</span></div>
        <div class="kv"><span>Where</span><span>${r.where.host} · ${r.where.coarse}</span></div>
        <div class="kv"><span>Badge</span><span class="pill ${r.what.badge==='green'?'green':'amber'}">${r.what.badge}</span></div>
        <div class="kv"><span>Flags</span><span>${r.flags.join(', ')}</span></div>
        ${r.revoke_of ? `<div class="kv"><span>Revokes</span><code class="mono cut">${r.revoke_of}</code></div>`:''}
        <div class="kv"><span>Key</span><span class="mono cut">${r.kid}</span></div>
      `;
    }
    mkView(greenSigned,'greenView');
    mkView(amberSigned,'amberView');
  })();
</script>
</body>
</html>
